# Dissecting CAPA Results Part 2: Malware Behavior Catalogue

Below, you will find the `capa.exe` output:

```powershell
    ┍━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ MBC Objective               │ MBC Behavior                                                                  │
    ┝━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ ANTI-BEHAVIORAL ANALYSIS    │ Virtual Machine Detection [B0009]
    ├─────────────────────────────┼───────────────────────────────━──────────────────────────────────────────────┤
    │ ANTI-STATIC ANALYSIS        │ Executable Code Obfuscation::Argument Obfuscation [B0032.020]                 │
    │                             │ Executable Code Obfuscation::Stack Strings [B0032.017]                        │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ COMMUNICATION               │ HTTP Communication [C0002]                                                    │
    │                             │ HTTP Communication::Read Header [C0002.014]                                   │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DATA                        │ Check String [C0019]                                                          │
    │                             │ Encode Data::Base64 [C0026.001]                                               │
    │                             │ Encode Data::XOR [C0026.002]                                                  │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DEFENSE EVASION             │ Obfuscated Files or Information::Encoding-Standard Algorithm [E1027.m02]      │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DISCOVERY                   │ File and Directory Discovery [E1083]                                          │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ EXECUTION                   │ Command and Scripting Interpreter [E1059]                                     │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ FILE SYSTEM                 │ Create Directory [C0046]                                                      │
    │                             │ Delete File [C0047]                                                           │
    │                             │ Read File [C0051]                                                             │
    │                             │ Writes File [C0052]                                                           │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ MEMORY                      │ Allocate Memory [C0007]                                                       │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ PROCESS                     │ Create Process [C0017]                                                        │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
```

## Malware Behavior Catalogue (<span style="color: inherit;">MBC</span>)

<span style="color: inherit;">MBC</span> is designed to support various aspects of malware analysis, such as labelling, similarity analysis, and standardized reporting. Essentially, it serves as a catalogue of malware objectives and behaviours. <span style="color: inherit;">MBC</span> can also link to ATT&CK methods and log all behaviours and code features discovered during malware analysis. It's important to note that the names of <span style="color: inherit;">MBC</span> behaviours may or may not match the corresponding ATT&CK techniques. The information on behaviour pages complements the content on ATT&CK pages. In other words, when recording malware behaviours, <span style="color: inherit;">MBC</span> users will reference ATT&CK, but <span style="color: inherit;">MBC</span> does not duplicate ATT&CK information.

The content of <span style="color: inherit;">MBC</span> below can be represented in two formats.

| Format | Sample | Explanation |
| --- | --- | --- |
| **OBJECTIVE**::**Behavior**::**Method**\[**Identifier**\] | ANTI-<span style="color: inherit;">STATIC ANALYSIS</span>::Executable Code Obfuscation::Argument Obfuscation \[B0032.020\] | **Anti-<span style="color: inherit;">static Analysis</span>** = OBJECTIVE  <br>**Executable Code Obfuscation** = BEHAVIOR  <br>**Argument Obfuscation** = METHOD  <br>**BOO32.020** = IDENTIFIER |
| **OBJECTIVE**::**Behavior**::\[**Identifier**\] | COMMUNICATION::<span style="color: inherit;">HTTP</span> Communication:: \[C0002\] | **COMMUNICATION** = OBJECTIVE  <br>**<span style="color: inherit;">HTTP</span> Communication** = BEHAVIOR  <br>**C0002** = IDENTIFIER |

The difference between the two formats is that the first format contains additional details called METHOD, which can also be coined as a sub-technique.

We must also discuss the Objective, Behavior, and Methods to better understand this part.

### Objective

The Objective are based on **ATT&CK tactics in the context of malware behaviour**, though not all are included. Furthermore, <span style="color: inherit;">MBC</span> has Anti-Behavioral and Anti-<span style="color: inherit;">Static Analysis</span>. These objectives are tailored for malware analysis with the use case of **characterizing malware**. See the table below for an explanation of each.

| **Objective** | **Explanation** |
| --- | --- |
| **Anti-Behavioral Analysis** | Malware attempts to avoid detection by hindering behavioural analysis using tools like sandboxes or debuggers. |
| **Anti-<span style="color: inherit;">Static Analysis</span>** | Malware attempts to obstruct or add complexity to <span style="color: inherit;">static analysis</span>, making it more challenging for security professionals to identify and understand its malicious behaviours and intentions. |
| **Collection** | Malware focuses on identifying and gathering information from the targeted machine or network. |
| **Command and Control** | Malware typically establishes communication with compromised systems through various methods such as command and control servers, peer-to-peer networks, or other means. This communication allows the malware to control the compromised systems, enabling the attackers to execute commands, exfiltrate data, or carry out other malicious activities. |
| **Credential Access** | The primary aim of malware is to steal account credentials, such as usernames and passwords. |
| **Defense Evasion** | The malware aims to bypass and circumvent the various detection and security mechanisms present within the system to avoid being detected or mitigated. |
| **Discovery** | Malware Seeks to collect detailed information about the configuration and setup of the system or network environment, including hardware, software, and network infrastructure. |
| **Execution** | Malware is designed to execute unauthorized commands or code on a targeted computer system without the user’s consent. This can include a wide range of harmful activities, such as stealing personal information, damaging files, or gaining unauthorized access to the system. |
| **Exfiltration** | Malware is designed to infiltrate computer systems or networks to steal and extract sensitive data. This can include personal information, financial details, and any other valuable data stored on the targeted system or network. |
| **Impact** | Malware aims to manipulate, disrupt, or damage computer systems and data. It can enter computers through infected emails, compromised websites, and other deceptive means, leading to financial loss, privacy breaches, and system instability. |
| **Lateral Movement** | Malware seeks to spread through the network, either actively through machine access or passively, such as via malicious emails. |
| **<span style="color: inherit;">Persistence</span>** | Malware is intentionally developed with the capability to remain undetected and operational on a computer system for an extended period. |
| **Privilege Escalation** | Malware seeks to infiltrate a computer system or network to gain elevated permissions or control. Once inside the target environment, malware can seek to escalate its privileges, access sensitive information, or take control of system resources for malicious purposes. |

### Micro-Objective

Micro-objectives are associated with micro-behaviors, which refer to an action or actions exhibited by potentially malicious software that isn't necessarily malicious and may serve various objectives. Example binaries are such as those in messaging apps. However, it's important to **note that these behaviours are typically abused.** That's why CAPA might have flagged this behaviour.

| **Micro-Objective** | **Description** |
| --- | --- |
| **PROCESS** | exhibiting behaviours related to processes such as but not limited to Creating Process, Setting Thread Context, Terminating Process, and Checking Mutex. |
| **MEMORY** | exhibiting behaviours such as, but not limited to, Allocating Memory, Changing Memory Protection, and Freeing Memory. |
| **COMMUNICATION** | exhibiting behaviours such as (not limited to (<span style="color: inherit;">DNS</span>, <span style="color: inherit;">FTP</span>, <span style="color: inherit;">HTTP</span>, ICMP, <span style="color: inherit;">SMTP</span>) network traffic. |
| **DATA** | exhibiting behaviours such as but not limited to Checking strings, compressing, decoding and encoding data |

The final output of CAPA, Objective, and Micro-Objective are shown only under the **Objective column**.

### MBCBehaviors

The column MBC Behaviors contains behaviours and Micro-behaviors with or without its methods and identifiers. Please check the link [<span style="color: inherit;">MBC</span> Summary](https://github.com/MBCProject/mbc-markdown/blob/main/mbc_summary.md) for a listing of all <span style="color: inherit;">MBC</span> content.

Below is a compiled version of Behaviors/Micro-behaviors and its Identifier.

| **Objective** | **Behavior** | Identifiers | Explanation |
| --- | --- | --- | --- |
| ANTI-BEHAVIORAL ANALYSIS | **Virtual Machine Detection** | **B0009** | The malware checks to see if it is running in a virtual environment. During its system reconnaissance, the malware examines various user and system artifacts. |
| ANTI-<span style="color: inherit;">STATIC ANALYSIS</span> | **Executable Code Obfuscation** | **B0032** | Executable code has been intentionally obscured to prevent static code analysis. This is a specific behavior related to the executable code of a malware sample, including its data and text sections. |
| EXECUTION | **Command and Scripting Interpreter** | **E1059** | Malware can exploit command and script interpreters to run malicious commands, scripts, or binaries. It targets built-in interpreters like cmd.exe or <span style="color: inherit;">PowerShell</span> on Windows or Bash on Unix-like systems. Attackers may also use other scripting languages like Python, Perl, or JavaScript. |
| DISCOVERY | **File and Directory Discovery** | **E1083** | Malware has the capability to search for specific files in particular locations by enumerating files and directories. |
| ANTI-<span style="color: inherit;">STATIC ANALYSIS</span>, DEFENSE EVASION | **Obfuscated Files or Information** | **E1027** | Malware can obfuscate files or information by encoding, encrypting, or otherwise, making them hard to analyze. It can also encode or encrypt malware samples itself. |

### Micro-Behavior

The term "low-level behaviors" in malware analysis refers to actions exhibited by malware that aren't necessarily malicious and may serve various objectives. These behaviors are often documented as "micro-behaviors" in the Malware Behavior Characteristics (<span style="color: inherit;">MBC</span>) analysis. Examples of such low-level behaviors include the creation of <span style="color: inherit;">TCP</span> sockets and evaluating specific conditions within strings. It's important to **note that just because a behavior is categorized as low-level does not mean it is harmless,** as it may still be part of a larger malicious scheme.

| **Micro-Objective** | **Micro-Behaviors** | Identifiers | Explanation |
| --- | --- | --- | --- |
| MEMORY | **Allocate Memory** | **C0007** | Malware frequently utilizes memory allocation as part of its strategy to unpack itself and execute its malicious activities. |
| PROCESS | **Create Process** | **C0017** | Malware creates a process via <span style="color: inherit;">WMI</span> or shellcode. It can also create a suspended process. |
| COMMUNICATION | **<span style="color: inherit;">HTTP</span> Communication** | **C0002** | Malware is capable of initiating <span style="color: inherit;">HTTP</span> communications. |
| DATA | **Check String** | **C0019** | Malware can inspect a string to identify specific characteristics, such as ASCII content, credit card numbers, and string length. |
| DATA | **Encode Data** | **C0026** | Malware has the capability to encode data using base64 and <span style="color: inherit;">XOR</span>. |
| FILE SYSTEM | **Create Directory** | **C0046** | Malware can create a directory. |
| FILE SYSTEM | **Delete File** | **C0047** | Malware has the capability to delete a file. |
| FILE SYSTEM | **Read File** | **C0051** | Malware can read a file. |
| FILE SYSTEM | **Writes File** | **C0052** | Malware has the capability to write to a file. |

Note that in the final output of CAPA, Behavior and Micro-Behavior are shown only under the **Behavior column**.

### Methods

Lastly, let’s check the **METHODS**. Below are some methods included in the results from the previous sample. Methods are tied to behaviors; therefore, to fully see all methods, please refer to each specific behavior/micro behavior of interest.

| Behavior | Methods or sub-technique | Identifier | Explanation |
| --- | --- | --- | --- |
| Executable Code Obfuscation | **Argument Obfuscation** | B0032.020 | Simple number or string arguments to <span style="color: inherit;">API</span> calls are calculated at runtime, making analysis more difficult. |
| Executable Code Obfuscation | **Stack Strings** | B0032.017 | Build and decrypt strings on the stack at each use, then discard to avoid obvious references. |
| <span style="color: inherit;">HTTP</span> Communication | **Read Header** | C0002.014 | <span style="color: inherit;">HTTP</span> read header. |
| Encode Data | **Base64** | C0026.001 | Malware may encode data using Base64. |
| Encode Data | **<span style="color: inherit;">XOR</span>** | C0026.002 | Malware may use <span style="color: inherit;">XOR</span> to encode data. |
| Obfuscated Files or Information | **Encoding-Standard Algorithm** | E1027.m02 | Encoding malware samples, files, or other information uses a standard algorithm (e.g., base64). |

&nbsp;

Now that we have a good overview and understanding of the <span style="color: inherit;">MBC</span>'s contents, we should be able to explain the result of the previous sample. Therefore, let's do a quick recap using one of the results. Shall we?

```powershell
┌─────────────────────────────┬──────────────────────────────────┐
│ MBC Objective               │ MBC Behavior                     │
├─────────────────────────────┼──────────────────────────────────┤
| DATA                        │ Encode Data::Base64 [C0026.001]  │
└─────────────────────────────┴──────────────────────────────────┘
```

Here's the explanation for the above result. See the table below.

| Label | Value | Explanation |
| --- | --- | --- |
| <span style="color: inherit;">MBC</span> Objective | **DATA** | exhibiting behaviors such as, but not limited to, checking strings, compressing, decoding, and encoding data. |
| <span style="color: inherit;">MBC</span> Behavior | **Encode Data** | Malware has the capability to encode data using base64 and <span style="color: inherit;">XOR</span>. |
| Method | **Base64** | Malware may encode data using Base64. |
| Identifier | **C0026.001** | identifier relays information about a behavior. This also serves as a tag. |